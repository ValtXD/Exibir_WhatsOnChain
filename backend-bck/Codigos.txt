require('dotenv').config();
const express = require('express');
const cors = require('cors');
const axios = require('axios');
const { PrivKey, Script, Transaction, Address } = require('bsv'); // ImportaÃ§Ã£o corrigida

const bsv = require('bsv');
    console.log("ðŸ” Testando bsv:", bsv);

const app = express();
const PORT = 3001;

app.use(express.json());
app.use(cors({ origin: 'http://localhost:3000' }));

console.log("ðŸ” Testando bsv.PrivateKey:", PrivKey); // Confirma se foi importado corretamente
//WIF: 5Ju3NoqVEfJAcaY6NkF8Ni63DMScM97Dovc76S5twiLakKFEtWD
//Pub_Key: 1JXSr5yrXS1P1QNJg2AymgHYPPnXNTovzF
//Private key: 8E7E3C95E982A7E3064FF9E6E8AB76EF5B589D7BE33A6F69ACFE17C37B69C24A
const PRIVATE_KEY = '8E7E3C95E982A7E3064FF9E6E8AB76EF5B589D7BE33A6F69ACFE17C37B69C24A';
//const PRIVATE_KEY = '5Ju3NoqVEfJAcaY6NkF8Ni63DMScM97Dovc76S5twiLakKFEtWD';
const PUBLIC_SCRIPT_KEY = '76a914c03c314d889417c569bd106181a78481834922b488ac';

try {
    //const key = new bsv.PrivKey().fromString(PRIVATE_KEY);
    //const key = bsv.PrivateKey.fromWIF(PRIVATE_KEY);
    //const key = bsv.PrivKey.fromString(PRIVATE_KEY);
    //const key = new bsv.PrivKey(PRIVATE_KEY);
    const key = PrivKey.fromHex(PRIVATE_KEY);
    
    console.log("âœ… Chave privada carregada com sucesso!");
} catch (error) {
    console.error("âŒ Erro ao carregar a chave privada:", error.message);
}

// FunÃ§Ã£o para criar a transaÃ§Ã£o OP_RETURN
const sendToWhatsOnChain = async (pacienteData) => {
    try {
        //const key = bsv.PrivateKey.fromWIF(PRIVATE_KEY);
        //const key = bsv.PrivKey.fromString(PRIVATE_KEY);
        const key = PrivKey.fromHex(PRIVATE_KEY);
        const address = key.toAddress().toString();
        console.log("âœ… EndereÃ§o da carteira:", address);

        // Buscar UTXOs
        const { data: utxos } = await axios.get(`https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`);
        if (utxos.length === 0) {
            throw new Error("âŒ Sem saldo suficiente na carteira.");
        }

        const utxo = utxos[0]; // Pegamos o primeiro UTXO disponÃ­vel
        console.log("âœ… UTXO selecionado:", utxo);

        const tx = new Transaction()
            .from([{
                txId: utxo.tx_hash,
                outputIndex: utxo.tx_pos,
                script: PUBLIC_SCRIPT_KEY, // Corrigido para usar o script correto
                satoshis: utxo.value,
            }])
            .addOutput(new Transaction.Output({
                script: Script.buildDataOut(JSON.stringify(pacienteData)), // OP_RETURN com os dados
                satoshis: 0, 
            }))
            .change(address) // O troco volta para o remetente
            .sign(key);

        console.log("âœ… TransaÃ§Ã£o assinada!");

        // Enviar para WhatsOnChain
        const rawTx = tx.serialize();
        console.log("ðŸ“¤ Enviando transaÃ§Ã£o para WhatsOnChain...");

        const { data: txid } = await axios.post('https://api.whatsonchain.com/v1/bsv/main/tx/raw', { txhex: rawTx });

        console.log("âœ… TransaÃ§Ã£o enviada com sucesso! TXID:", txid);
        return txid;
    } catch (error) {
        console.error('âŒ Erro ao enviar transaÃ§Ã£o:', error.message);
        throw new Error('Falha ao enviar para WhatsOnChain');
    }
};

// Rota para enviar transaÃ§Ã£o
app.post('/api/enviar-transacao', async (req, res) => {
    try {
        const pacienteData = req.body;
        console.log("ðŸ“¥ Recebendo dados para transaÃ§Ã£o:", pacienteData);

        const txid = await sendToWhatsOnChain(pacienteData);
        res.json({ success: true, txid });
    } catch (error) {
        res.status(500).json({ success: false, message: error.message });
    }
});

app.listen(PORT, () => {
    console.log(`âœ… Servidor rodando na porta ${PORT}`);
});
==========================================================